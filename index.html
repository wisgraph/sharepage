<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ShareHub</title>
  <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@11.6.0/dist/mermaid.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
      background-color: #ffffff;
      color: #1f2937;
      line-height: 1.6;
    }

    body.theme-dark {
      background-color: #0d1117;
      color: #e6edf3;
    }

    /* Navigation Bar */
    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background-color: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      z-index: 1000;
    }

    body.theme-dark .navbar {
      background-color: rgba(13, 17, 23, 0.95);
      border-bottom-color: #30363d;
    }

    .navbar-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .navbar-logo {
      font-size: 20px;
      font-weight: 700;
      color: #111827;
      text-decoration: none;
    }

    body.theme-dark .navbar-logo {
      color: #e6edf3;
    }

    .navbar-home {
      padding: 8px 16px;
      background-color: #f3f4f6;
      color: #374151;
      text-decoration: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      transition: background-color 0.2s;
    }

    .navbar-home:hover {
      background-color: #e5e7eb;
    }

    body.theme-dark .navbar-home {
      background-color: #21262d;
      color: #e6edf3;
    }

    body.theme-dark .navbar-home:hover {
      background-color: #30363d;
    }

    .navbar-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .theme-toggle {
      padding: 8px;
      background: transparent;
      border: none;
      cursor: pointer;
      border-radius: 6px;
      color: #6b7280;
      transition: color 0.2s;
    }

    .theme-toggle:hover {
      color: #111827;
    }

    body.theme-dark .theme-toggle:hover {
      color: #e6edf3;
    }

    /* Main Content */
    .main-content {
      margin-top: 80px;
      padding: 0 24px 40px;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }

    /* Dashboard Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .note-card {
      background-color: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
    }

    .note-card:hover {
      border-color: #3b82f6;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }

    body.theme-dark .note-card {
      background-color: #161b22;
      border-color: #30363d;
    }

    body.theme-dark .note-card:hover {
      border-color: #58a6ff;
    }

    .note-card-thumbnail {
      width: 100%;
      height: 160px;
      background-color: #f3f4f6;
      object-fit: cover;
      border-bottom: 1px solid #e5e7eb;
    }

    body.theme-dark .note-card-thumbnail {
      background-color: #21262d;
      border-bottom-color: #30363d;
    }

    .note-card-thumbnail-placeholder {
      width: 100%;
      height: 160px;
      background-color: #f3f4f6;
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid #e5e7eb;
    }

    body.theme-dark .note-card-thumbnail-placeholder {
      background-color: #21262d;
      border-bottom-color: #30363d;
    }

    .note-card-thumbnail-placeholder svg {
      width: 48px;
      height: 48px;
      color: #9ca3af;
    }

    body.theme-dark .note-card-thumbnail-placeholder svg {
      color: #6e7681;
    }

    .note-card-content {
      padding: 16px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .note-card-title {
      font-size: 18px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
      line-height: 1.4;
    }

    body.theme-dark .note-card-title {
      color: #e6edf3;
    }

    .note-card-preview {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 12px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-height: 1.5;
      flex: 1;
    }

    body.theme-dark .note-card-preview {
      color: #8b949e;
    }

    .note-card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: #9ca3af;
      margin-top: auto;
    }

    body.theme-dark .note-card-footer {
      color: #6e7681;
    }

    .note-card-tag {
      background-color: #f3f4f6;
      color: #6b7280;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }

    body.theme-dark .note-card-tag {
      background-color: #21262d;
      color: #8b949e;
    }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-top: 40px;
    }

    .pagination button {
      padding: 8px 16px;
      background-color: #f3f4f6;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
      transition: all 0.2s;
    }

    .pagination button:hover:not(:disabled) {
      background-color: #e5e7eb;
      border-color: #d1d5db;
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination button.active {
      background-color: #3b82f6;
      color: #ffffff;
      border-color: #3b82f6;
    }

    body.theme-dark .pagination button {
      background-color: #21262d;
      border-color: #30363d;
      color: #e6edf3;
    }

    body.theme-dark .pagination button:hover:not(:disabled) {
      background-color: #30363d;
      border-color: #484f58;
    }

    body.theme-dark .pagination button.active {
      background-color: #58a6ff;
      border-color: #58a6ff;
    }

    /* Document Content */
    .document-container {
      background-color: #ffffff;
      padding: 40px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
    }

    body.theme-dark .document-container {
      background-color: #161b22;
      border-color: #30363d;
    }

    .loading, .error {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }

    .error {
      color: #dc2626;
    }

    /* Markdown Styles */
    .markdown h1 {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid #e5e7eb;
      color: #111827;
    }

    .markdown h2 {
      font-size: 26px;
      font-weight: 600;
      margin-top: 32px;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #f3f4f6;
      color: #111827;
    }

    .markdown h3 {
      font-size: 22px;
      font-weight: 600;
      margin-top: 28px;
      margin-bottom: 12px;
      color: #111827;
    }

    .markdown h4 {
      font-size: 18px;
      font-weight: 600;
      margin-top: 24px;
      margin-bottom: 10px;
      color: #111827;
    }

    body.theme-dark .markdown h1,
    body.theme-dark .markdown h2,
    body.theme-dark .markdown h3,
    body.theme-dark .markdown h4 {
      color: #e6edf3;
    }

    body.theme-dark .markdown h1 {
      border-bottom-color: #30363d;
    }

    body.theme-dark .markdown h2 {
      border-bottom-color: #21262d;
    }

    .markdown p {
      margin-bottom: 16px;
      font-size: 16px;
      line-height: 1.8;
    }

    .markdown ul, .markdown ol {
      margin-left: 28px;
      margin-bottom: 16px;
      font-size: 16px;
      line-height: 1.8;
    }

    .markdown li {
      margin-bottom: 8px;
    }

    .markdown a {
      color: #3b82f6;
      text-decoration: none;
      border-bottom: 1px solid transparent;
      transition: border-color 0.2s;
    }

    .markdown a:hover {
      border-bottom-color: #3b82f6;
    }

    body.theme-dark .markdown a {
      color: #58a6ff;
    }

    body.theme-dark .markdown a:hover {
      border-bottom-color: #58a6ff;
    }

    .markdown code {
      background-color: #f3f4f6;
      padding: 2px 8px;
      border-radius: 4px;
      font-family: 'SF Mono', Monaco, Consolas, 'Courier New', monospace;
      font-size: 0.9em;
      color: #ef4444;
    }

    body.theme-dark .markdown code {
      background-color: #0d1117;
      color: #ff7b72;
    }

    .markdown pre {
      background-color: #0d1117;
      padding: 20px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 24px 0;
      border: 1px solid #30363d;
    }

    .markdown pre code {
      background-color: transparent;
      padding: 0;
      font-size: 14px;
      line-height: 1.6;
      color: #e6edf3;
    }

    .markdown .hljs {
      background-color: transparent !important;
    }

    .markdown blockquote {
      border-left: 4px solid #3b82f6;
      padding: 16px 20px;
      margin: 20px 0;
      background-color: #f9fafb;
      color: #4b5563;
      font-style: italic;
      border-radius: 0 8px 8px 0;
    }

    body.theme-dark .markdown blockquote {
      background-color: #161b22;
      color: #8b949e;
      border-left-color: #58a6ff;
    }

    .markdown table {
      border-collapse: collapse;
      width: 100%;
      margin: 24px 0;
      border-radius: 8px;
      overflow: hidden;
    }

    .markdown th, .markdown td {
      border: 1px solid #e5e7eb;
      padding: 12px 16px;
      text-align: left;
      font-size: 14px;
    }

    .markdown th {
      background-color: #f9fafb;
      font-weight: 600;
      color: #111827;
    }

    .markdown tr:nth-child(even) {
      background-color: #f9fafb;
    }

    body.theme-dark .markdown th,
    body.theme-dark .markdown td {
      border-color: #30363d;
    }

    body.theme-dark .markdown th {
      background-color: #161b22;
      color: #e6edf3;
    }

    body.theme-dark .markdown tr:nth-child(even) {
      background-color: #0d1117;
    }

    .markdown hr {
      border: none;
      border-top: 2px solid #e5e7eb;
      margin: 40px 0;
    }

    body.theme-dark .markdown hr {
      border-top-color: #30363d;
    }

    /* Checkboxes */
    .markdown input[type="checkbox"] {
      margin-right: 8px;
      cursor: pointer;
    }

    /* Mermaid Diagram */
    .mermaid {
      background-color: #f9fafb;
      border-radius: 8px;
      padding: 20px;
      margin: 24px 0;
      border: 1px solid #e5e7eb;
    }

    body.theme-dark .mermaid {
      background-color: #0d1117;
      border-color: #30363d;
    }

    /* KaTeX */
    .katex {
      font-size: 1.05em;
    }

    .katex-display {
      margin: 24px 0;
      overflow-x: auto;
      overflow-y: hidden;
      padding: 12px 0;
    }

    /* Back Button */
    .back-button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background-color: #f3f4f6;
      color: #374151;
      text-decoration: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 20px;
      transition: all 0.2s;
    }

    .back-button:hover {
      background-color: #e5e7eb;
      transform: translateX(-4px);
    }

    body.theme-dark .back-button {
      background-color: #21262d;
      color: #e6edf3;
    }

    body.theme-dark .back-button:hover {
      background-color: #30363d;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .navbar {
        padding: 0 16px;
      }

      .main-content {
        padding: 0 16px 32px;
        margin-top: 70px;
      }

      .document-container {
        padding: 24px;
      }

      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-left">
      <a href="#/" class="navbar-logo">ShareHub</a>
      <a href="#/" class="navbar-home">Dashboard</a>
    </div>
    <div class="navbar-right">
      <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
        <svg id="theme-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="5"></circle>
          <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path>
        </svg>
      </button>
    </div>
  </nav>

  <div class="main-content" id="app">
    <!-- Dynamic content will be injected here -->
  </div>

  <script>
    const github = {
      owner: 'wis-graph',
      repo: 'sharepage',
      branch: 'gh-pages'
    };

    const routes = {
      '/': {
        title: 'Home',
        file: '_home.md'
      },
      '/note-welcome': {
        title: 'Welcome',
        file: 'note-welcome.md'
      },
      '/note-todo': {
        title: 'Todo',
        file: 'note-todo.md'
      }
    };

    const PAGINATION_ITEMS_PER_PAGE = 9;

    let currentPage = 1;
    let allNotes = [];

    function getRawUrl(filename) {
      return `https://raw.githubusercontent.com/${github.owner}/${github.repo}/${github.branch}/${filename}`;
    }

    async function fetchFile(filename) {
      console.log('[Fetch] Fetching:', filename);
      const url = getRawUrl(filename);
      console.log('[Fetch] URL:', url);

      try {
        const response = await fetch(url);
        console.log('[Fetch] Response status:', response.status);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const text = await response.text();
        console.log('[Fetch] Content length:', text.length);
        return text;
      } catch (error) {
        console.error('[Fetch] Error:', error);
        throw error;
      }
    }

    function extractDashboardLinks(dashboardContent) {
      console.log('[Dashboard] Extracting links from dashboard...');

      const links = [];
      const linkMatches = dashboardContent.matchAll(/\[\[([^\]]+)\]\]/g);

      for (const match of linkMatches) {
        const linkText = match[1];
        const cleanLink = linkText.replace(/\.md$/, '').trim();
        links.push(cleanLink);
      }

      console.log('[Dashboard] Found', links.length, 'links in dashboard');
      return links;
    }

    function extractMetadata(markdown, filename) {
      const frontmatterMatch = markdown.match(/^---\n([\s\S]*?)\n---/);
      let title = filename.replace(/\.md$/, '').replace(/^_/, '').replace(/^note-/, '');
      let description = '';
      let thumbnail = null;

      if (frontmatterMatch) {
        const frontmatter = frontmatterMatch[1];
        const titleMatch = frontmatter.match(/^title:\s*(.+)$/m);
        if (titleMatch) {
          title = titleMatch[1].trim().replace(/^["']|["']$/g, '');
        }

        const thumbnailMatch = frontmatter.match(/^thumbnail:\s*(.+)$/m);
        if (thumbnailMatch) {
          thumbnail = thumbnailMatch[1].trim().replace(/^["']|["']$/g, '');
        }
      }

      const contentWithoutFrontmatter = frontmatterMatch
        ? markdown.replace(/^---\n[\s\S]*?\n---\n/, '')
        : markdown;

      const firstParagraph = contentWithoutFrontmatter.match(/^#+\s*(.+)$/m) ||
                            contentWithoutFrontmatter.match(/^(?!\s*$|#+\s).+/m);

      if (firstParagraph) {
        description = firstParagraph[1]
          .replace(/[#*`_\[\]]/g, '')
          .substring(0, 150);
      }

      return {
        title: title.charAt(0).toUpperCase() + title.slice(1),
        description: description || 'No description available.',
        filename: filename,
        thumbnail: thumbnail
      };
    }

    function extractFirstImage(markdown) {
      console.log('[Thumbnail] Searching for first image in content...');

      const imageMatch = markdown.match(/!\[\[([^\]]+)\]\]/);
      if (imageMatch) {
        console.log('[Thumbnail] Found image:', imageMatch[1]);
        return getRawUrl('_image_' + imageMatch[1]);
      }

      console.log('[Thumbnail] No image found');
      return null;
    }

    async function loadDashboardNotes() {
      console.log('[Dashboard] Loading dashboard notes...');

      try {
        const dashboardContent = await fetchFile('_home.md');
        const links = extractDashboardLinks(dashboardContent);

        allNotes = [];

        for (const link of links) {
          const route = Object.entries(routes).find(([path, route]) => {
            const filenameWithoutExt = route.file.replace(/\.md$/, '');
            return filenameWithoutExt === link || path === '/' + link;
          });

          if (route) {
            const [path, routeData] = route;
            const note = {
              path,
              file: routeData.file,
              title: routeData.title
            };

            try {
              const content = await fetchFile(note.file);
              const metadata = extractMetadata(content, note.file);
              note.title = metadata.title;
              note.description = metadata.description;

              if (metadata.thumbnail) {
                note.thumbnail = getRawUrl('_image_' + metadata.thumbnail);
              } else {
                const firstImage = extractFirstImage(content);
                note.thumbnail = firstImage;
              }

              allNotes.push(note);
            } catch (error) {
              console.error('[Dashboard] Error loading note:', note.file, error);
            }
          } else {
            console.warn('[Dashboard] No route found for link:', link);
          }
        }

        allNotes.sort((a, b) => a.title.localeCompare(b.title));
        console.log('[Dashboard] Loaded', allNotes.length, 'notes');
      } catch (error) {
        console.error('[Dashboard] Error loading dashboard:', error);
        allNotes = [];
      }
    }

    function renderDashboardPage(page) {
      const startIndex = (page - 1) * PAGINATION_ITEMS_PER_PAGE;
      const endIndex = startIndex + PAGINATION_ITEMS_PER_PAGE;
      const notesToShow = allNotes.slice(startIndex, endIndex);
      const totalPages = Math.ceil(allNotes.length / PAGINATION_ITEMS_PER_PAGE);

      let html = '';

      if (allNotes.length === 0) {
        html += '<div class="loading">No notes found.</div>';
        return html;
      }

      html += '<div class="dashboard-grid">';

      for (const note of notesToShow) {
        let thumbnailHtml;

        if (note.thumbnail) {
          thumbnailHtml = `<img class="note-card-thumbnail" src="${note.thumbnail}" alt="${note.title}" loading="lazy">`;
        } else {
          thumbnailHtml = `
            <div class="note-card-thumbnail-placeholder">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                <line x1="9" y1="3" x2="9" y2="21" />
              </svg>
            </div>
          `;
        }

        html += `
          <div class="note-card" onclick="window.location.hash='${note.path}'">
            ${thumbnailHtml}
            <div class="note-card-content">
              <div class="note-card-title">${note.title}</div>
              <div class="note-card-preview">${note.description}</div>
              <div class="note-card-footer">
                <span class="note-card-tag">Note</span>
                <span>Read →</span>
              </div>
            </div>
          </div>
        `;
      }

      html += '</div>';

      if (totalPages > 1) {
        html += '<div class="pagination">';

        if (page > 1) {
          html += `<button onclick="goToPage(${page - 1})">Previous</button>`;
        }

        for (let i = 1; i <= totalPages; i++) {
          html += `<button onclick="goToPage(${i})" ${i === page ? 'class="active"' : ''}>${i}</button>`;
        }

        if (page < totalPages) {
          html += `<button onclick="goToPage(${page + 1})">Next</button>`;
        }

        html += '</div>';
      }

      return html;
    }

    function goToPage(page) {
      currentPage = page;
      const html = renderDashboardPage(page);
      document.getElementById('app').innerHTML = html;
      window.scrollTo(0, 0);
    }

    function convertInternalLinks(html) {
      return html.replace(
        /\[\[(.*?)\]\]/g,
        (match, filename) => {
          const path = '/' + filename.replace(/\.md$/, '');
          return `<a href="#${path}" class="internal-link">${filename}</a>`;
        }
      );
    }

    function convertImageLinks(markdown) {
      console.log('[Render] Converting image links');

      return markdown.replace(
        /!\[\[(.*?)\]\]/g,
        (match, filename) => {
          const url = getRawUrl('_image_' + filename);
          return `![${filename}](${url})`;
        }
      );
    }

    function applySyntaxHighlighting(html) {
      console.log('[Highlight] Applying syntax highlighting');
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');

      const codeBlocks = doc.querySelectorAll('pre code');
      console.log('[Highlight] Found', codeBlocks.length, 'code blocks');

      codeBlocks.forEach((block) => {
        const code = block.textContent;
        const language = block.className.match(/language-(\w+)/)?.[1];

        if (language && hljs.getLanguage(language)) {
          const result = hljs.highlight(code, { language: language, ignoreIllegals: true });
          block.innerHTML = result.value;
          block.className = `hljs language-${language}`;
        } else {
          const result = hljs.highlightAuto(code);
          block.innerHTML = result.value;
          block.className = 'hljs';
        }
      });

      console.log('[Highlight] Syntax highlighting applied');
      return doc.body.innerHTML;
    }

    function renderMermaidDiagrams(html) {
      console.log('[Mermaid] Rendering diagrams');
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');

      const mermaidBlocks = doc.querySelectorAll('pre code.language-mermaid, code.language-mermaid');
      console.log('[Mermaid] Found', mermaidBlocks.length, 'mermaid blocks');

      mermaidBlocks.forEach((block) => {
        const code = block.textContent.trim();
        const wrapper = document.createElement('div');
        wrapper.className = 'mermaid';
        wrapper.textContent = code;
        block.parentElement.replaceWith(wrapper);
      });

      return doc.body.innerHTML;
    }

    function renderMath(html) {
      console.log('[Math] Rendering math expressions');

      html = html.replace(/\$\$([\s\S]*?)\$\$/g, (match, math) => {
        try {
          return katex.renderToString(math.trim(), { displayMode: true });
        } catch (e) {
          console.error('[Math] Error rendering display math:', e);
          return match;
        }
      });

      html = html.replace(/\$([^$\n]+?)\$/g, (match, math) => {
        try {
          return katex.renderToString(math.trim(), { displayMode: false });
        } catch (e) {
          console.error('[Math] Error rendering inline math:', e);
          return match;
        }
      });

      return html;
    }

    async function navigate(hash) {
      if (hash === '/') {
        document.getElementById('app').innerHTML = '<div class="loading">Loading dashboard...</div>';
        document.title = 'Dashboard - ShareHub';

        console.log('[Router] Loading dashboard');

        if (allNotes.length === 0) {
          await loadDashboardNotes();
        }

        const html = renderDashboardPage(currentPage);
        document.getElementById('app').innerHTML = html;
      } else {
        const route = routes[hash];

        if (route) {
          document.getElementById('app').innerHTML = '<div class="loading">Loading...</div>';
          document.title = route.title + ' - ShareHub';

          console.log('[Router] Navigating to:', hash);

          try {
            let content = await fetchFile(route.file);
            console.log('[Render] Original markdown length:', content.length);

            content = convertImageLinks(content);
            console.log('[Render] Markdown after image conversion length:', content.length);

            console.log('[Render] Parsing markdown with marked.js');
            let html = marked.parse(content);

            html = applySyntaxHighlighting(html);

            html = renderMermaidDiagrams(html);

            html = renderMath(html);

            html = convertInternalLinks(html);

            const backLink = '<a href="#/" class="back-button">← Back to Dashboard</a>';

            document.getElementById('app').innerHTML = `
              ${backLink}
              <div class="document-container markdown">${html}</div>
            `;

            await mermaid.run({
              nodes: document.querySelectorAll('.mermaid')
            });

            console.log('[Router] Content rendered');
          } catch (error) {
            console.error('[Router] Error:', error);
            document.getElementById('app').innerHTML = '<div class="error">Error: ' + error.message + '</div>';
          }
        } else {
          console.log('[Router] Route not found:', hash);
          document.getElementById('app').innerHTML = '<h1>404 Not Found</h1><p>The route "' + hash + '" does not exist.</p>';
        }
      }
    }
      } else if (hash === '/') {
        document.getElementById('app').innerHTML = '<div class="loading">Loading dashboard...</div>';
        document.title = 'Dashboard - ShareHub';

        console.log('[Router] Loading dashboard');

        if (allNotes.length === 0) {
          await loadDashboardNotes();
        }

        const html = renderDashboardPage(currentPage);
        document.getElementById('app').innerHTML = html;
      } else {
        console.log('[Router] Route not found:', hash);
        document.getElementById('app').innerHTML = '<h1>404 Not Found</h1><p>The route "' + hash + '" does not exist.</p>';
      }
    }

    function handleHashChange() {
      const hash = window.location.hash.slice(1) || '/';
      console.log('[Router] Hash changed:', hash);
      navigate(hash);
    }

    function initTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.body.className = savedTheme === 'dark' ? 'theme-dark' : '';
      updateThemeIcon(savedTheme);
    }

    function updateThemeIcon(theme) {
      const icon = document.getElementById('theme-icon');
      if (theme === 'dark') {
        icon.innerHTML = `
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        `;
      } else {
        icon.innerHTML = `
          <circle cx="12" cy="12" r="5"></circle>
          <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path>
        `;
      }
    }

    function toggleTheme() {
      const isDark = document.body.classList.toggle('theme-dark');
      const theme = isDark ? 'dark' : 'light';
      localStorage.setItem('theme', theme);
      updateThemeIcon(theme);
      console.log('[Theme] Switched to', theme);
    }

    document.addEventListener('DOMContentLoaded', () => {
      console.log('[App] Initializing...');

      console.log('[App] marked.js loaded:', typeof marked !== 'undefined');
      console.log('[App] highlight.js loaded:', typeof hljs !== 'undefined');
      console.log('[App] mermaid loaded:', typeof mermaid !== 'undefined');
      console.log('[App] katex loaded:', typeof katex !== 'undefined');

      if (typeof hljs === 'undefined') {
        console.error('[App] Error: highlight.js is not loaded');
        document.getElementById('app').innerHTML = '<div class="error">Error: highlight.js failed to load. Please refresh the page.</div>';
        return;
      }

      mermaid.initialize({ startOnLoad: false, theme: 'default' });

      initTheme();
      document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

      handleHashChange();
    });

    window.addEventListener('hashchange', handleHashChange);
  </script>
</body>
</html>
